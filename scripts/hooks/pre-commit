#!/bin/bash
# pre-commit hook - Verify git-crypt is working before committing encrypted files
#
# Install with:
#   cp scripts/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

ENCRYPTED_PATTERNS=(
    "context/*"
    "briefings/*"
    "work/*"
    "reviews/*"
    "investigations/*"
    "rubberduck/*"
    "meetings/*"
    "121/*"
)

# Check if any staged files match encrypted patterns
staged_encrypted=""
for pattern in "${ENCRYPTED_PATTERNS[@]}"; do
    matches=$(git diff --cached --name-only -- "$pattern" 2>/dev/null)
    if [ -n "$matches" ]; then
        staged_encrypted="${staged_encrypted}${matches}"$'\n'
    fi
done

# If no encrypted files staged, allow commit
if [ -z "$staged_encrypted" ]; then
    exit 0
fi

# Verify git-crypt filters are configured
smudge=$(git config --get filter.git-crypt.smudge 2>/dev/null || echo "")
clean=$(git config --get filter.git-crypt.clean 2>/dev/null || echo "")

if [ -z "$smudge" ] || [ -z "$clean" ]; then
    echo "ERROR: git-crypt filters not configured!"
    echo ""
    echo "You're trying to commit files that should be encrypted:"
    echo "$staged_encrypted"
    echo ""
    echo "But git-crypt is not set up. Run:"
    echo "  git-crypt unlock"
    echo ""
    exit 1
fi

if [[ "$smudge" == "cat" ]] || [[ "$clean" == "cat" ]]; then
    echo "ERROR: git-crypt filters are bypassed!"
    echo ""
    echo "You're trying to commit files that should be encrypted:"
    echo "$staged_encrypted"
    echo ""
    echo "But encryption filters are disabled. Run:"
    echo "  git-crypt unlock"
    echo ""
    exit 1
fi

# Check that git-crypt keys exist
if [ ! -d ".git/git-crypt/keys" ]; then
    echo "ERROR: git-crypt keys not found!"
    echo ""
    echo "You're trying to commit files that should be encrypted:"
    echo "$staged_encrypted"
    echo ""
    echo "Run: git-crypt unlock"
    echo ""
    exit 1
fi

# Round-trip decryption test: verify staged encrypted blobs can be decrypted
# Pick the first staged encrypted file and smudge its blob from the index
test_file=$(echo "$staged_encrypted" | head -1 | tr -d '[:space:]')
if [ -n "$test_file" ] && [ -f "$test_file" ]; then
    # Get the blob hash from the index for this file
    blob_hash=$(git ls-files -s -- "$test_file" 2>/dev/null | awk '{print $2}')
    if [ -n "$blob_hash" ]; then
        # Extract the raw blob and run it through smudge to verify it decrypts
        smudge_output=$(git cat-file blob "$blob_hash" 2>/dev/null | git-crypt smudge 2>/dev/null) || true
        original_head=$(head -c 200 "$test_file")
        smudge_head=$(echo "$smudge_output" | head -c 200)
        if [ -z "$smudge_output" ] || [ "$smudge_head" != "$original_head" ]; then
            echo "ERROR: git-crypt round-trip test failed for: $test_file"
            echo ""
            echo "The staged encrypted blob could not be decrypted back to"
            echo "the original content. This means the file would be"
            echo "unrecoverable after push."
            echo ""
            echo "This is usually caused by text normalization interfering with"
            echo "the encryption filter. Check .gitattributes has -text on"
            echo "git-crypt rules, and run:"
            echo "  git rm --cached <files> && git add <files>"
            echo ""
            exit 1
        fi
    fi
fi

# All checks passed
exit 0
